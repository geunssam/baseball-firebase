rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // ê³µìœ  ì‹œìŠ¤í…œ ë°ì´í„° êµ¬ì¡° (Phase 1)
    // ============================================
    /*
     * shares ì»¬ë ‰ì…˜: êµì‚¬ ê°„ í•™ê¸‰/íŒ€ ê³µìœ  ì •ë³´
     *
     * êµ¬ì¡°:
     * {
     *   shareId: "auto-generated-doc-id",
     *   ownerId: "teacher-a-uid",          // ì› ì†Œìœ ì UID
     *   ownerName: "ê¹€ì„ ìƒë‹˜",              // ì› ì†Œìœ ì ì´ë¦„
     *   inviteCode: "uuid-v4",             // ì´ˆëŒ€ ì½”ë“œ (UUID)
     *   items: [                           // ê³µìœ í•  í•­ëª© ë°°ì—´
     *     { type: "class", id: "classId1", name: "3í•™ë…„ 1ë°˜" },
     *     { type: "team", id: "teamId1", name: "ë ˆë“œíŒ€" }
     *   ],
     *   permissions: {                     // ê¶Œí•œ ê´€ë¦¬
     *     viewers: ["teacher-b-uid"],      // ì¡°íšŒë§Œ ê°€ëŠ¥
     *     editors: ["teacher-c-uid"],      // ê²½ê¸° ì§„í–‰ ê°€ëŠ¥
     *     owners: ["teacher-a-uid"]        // ì „ì²´ ê´€ë¦¬ (ì› ì†Œìœ ì)
     *   },
     *   createdAt: timestamp,
     *   updatedAt: timestamp
     * }
     *
     * users/{userId}/sharedWithMe ì„œë¸Œì»¬ë ‰ì…˜: ë‚´ê°€ ì°¸ì—¬ ì¤‘ì¸ ê³µìœ  ëª©ë¡
     *
     * êµ¬ì¡°:
     * {
     *   shareId: "share-doc-id",           // shares ì»¬ë ‰ì…˜ì˜ ë¬¸ì„œ ID
     *   ownerId: "teacher-a-uid",          // ì› ì†Œìœ ì UID
     *   ownerName: "ê¹€ì„ ìƒë‹˜",              // ì› ì†Œìœ ì ì´ë¦„
     *   permission: "editor",              // ë‚´ ê¶Œí•œ (viewer, editor, owner)
     *   joinedAt: timestamp                // ì°¸ì—¬ ì¼ì‹œ
     * }
     */

    // ============================================
    // í—¬í¼ í•¨ìˆ˜
    // ============================================

    // ë¡œê·¸ì¸ í™•ì¸
    function isSignedIn() {
      return request.auth != null;
    }

    // ë°ì´í„° ì†Œìœ ì í™•ì¸
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ê³µìœ  ê¶Œí•œ í™•ì¸ (Phase 1)
    // shareDocId: shares ì»¬ë ‰ì…˜ì˜ ë¬¸ì„œ ID (í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì „ë‹¬)
    // requiredLevel: "viewer", "editor", "owner" ì¤‘ í•˜ë‚˜
    //
    // âš ï¸ ì¤‘ìš”: Firestore Rulesì˜ ì œì•½ìœ¼ë¡œ ì¸í•´ ë³µì¡í•œ ì¿¼ë¦¬ê°€ ì–´ë µìŠµë‹ˆë‹¤.
    // ë”°ë¼ì„œ í´ë¼ì´ì–¸íŠ¸ ì½”ë“œì—ì„œ shareDocIdë¥¼ í•¨ê»˜ ì „ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤.
    function hasSharePermission(shareDocId, requiredLevel) {
      let userId = request.auth.uid;
      let shareDoc = get(/databases/$(database)/documents/shares/$(shareDocId)).data;

      // ìš”ì²­í•œ ê¶Œí•œ ë ˆë²¨ì— ë”°ë¼ ì ‘ê·¼ í—ˆìš© ì—¬ë¶€ íŒë‹¨
      return (requiredLevel == 'viewer' &&
              (userId in shareDoc.permissions.viewers ||
               userId in shareDoc.permissions.editors ||
               userId in shareDoc.permissions.owners)) ||
             (requiredLevel == 'editor' &&
              (userId in shareDoc.permissions.editors ||
               userId in shareDoc.permissions.owners)) ||
             (requiredLevel == 'owner' &&
              userId in shareDoc.permissions.owners);
    }

    // íŠ¹ì • ì†Œìœ ìì˜ íŠ¹ì • í•­ëª©ì— ëŒ€í•œ ê³µìœ  ê¶Œí•œ í™•ì¸
    // ownerId: ë°ì´í„° ì†Œìœ ì UID
    // userId: ì ‘ê·¼ ìš”ì²­ì UID
    //
    // âš ï¸ ì´ í•¨ìˆ˜ëŠ” ë‹¨ìˆœí™”ëœ ë²„ì „ì…ë‹ˆë‹¤.
    // ì‹¤ì œë¡œëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ sharedWithMe ì»¬ë ‰ì…˜ì„ ì¡°íšŒí•˜ì—¬
    // ê¶Œí•œì„ í™•ì¸í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•©ë‹ˆë‹¤.
    function hasSharedAccess(ownerId, userId) {
      return userId == ownerId ||
             exists(/databases/$(database)/documents/users/$(userId)/sharedWithMe/$(ownerId));
    }

    // ============================================
    // CollectionGroup ì¿¼ë¦¬ ì§€ì› (í•™ìƒ ë¡œê·¸ì¸ìš©)
    // ============================================

    // í•™ìƒ ì½”ë“œë¡œ ë¡œê·¸ì¸í•  ë•Œ ëª¨ë“  usersì˜ students ì»¬ë ‰ì…˜ ê²€ìƒ‰ í—ˆìš©
    match /{path=**}/students/{studentId} {
      allow read: if true;  // í•™ìƒ ì½”ë“œë¡œ ë¡œê·¸ì¸í•˜ê¸° ìœ„í•´ collectionGroup ì¿¼ë¦¬ í—ˆìš©
    }

    // í•™ìƒìš© ë°ì´í„° ì¡°íšŒë¥¼ ìœ„í•œ collectionGroup ê·œì¹™ë“¤
    match /{path=**}/finishedGames/{gameId} {
      allow read: if true;  // í•™ìƒì´ ê²½ê¸° ê¸°ë¡ì„ ë³¼ ìˆ˜ ìˆë„ë¡
    }
    match /{path=**}/games/{gameId} {
      allow read: if true;  // í•™ìƒì´ ì§„í–‰ ì¤‘ì¸ ê²½ê¸°ë¥¼ ë³¼ ìˆ˜ ìˆë„ë¡
    }
    
    match /{path=**}/playerBadges/{playerId} {
      allow read: if true;  // í•™ìƒì´ ë°°ì§€ë¥¼ ë³¼ ìˆ˜ ìˆë„ë¡
    }

    match /{path=**}/playerHistory/{playerId} {
      allow read: if true;  // í•™ìƒì´ ê¸°ë¡ì„ ë³¼ ìˆ˜ ìˆë„ë¡
    }

    // ============================================
    // ì‚¬ìš©ìë³„ ë°ì´í„° (users ì»¬ë ‰ì…˜)
    // ============================================

    match /users/{userId} {
      // í”„ë¡œí•„: ë³¸ì¸ë§Œ ì“°ê¸°, ë¡œê·¸ì¸í•œ ì‚¬ëŒì€ ì½ê¸° ê°€ëŠ¥ (êµì‚¬ ëª©ë¡ í‘œì‹œìš©)
      match /profile/{document=**} {
        allow read: if isSignedIn();
        allow write: if isOwner(userId);
      }

      // í•™ìƒ ë°ì´í„° (Phase 1: ê³µìœ  ê¶Œí•œ ì¶”ê°€)
      match /students/{studentId} {
        // ì½ê¸°: ì†Œìœ ìë§Œ ê°€ëŠ¥ (ìì‹ ì˜ í•™ìƒë§Œ ì¡°íšŒ)
        allow read: if isOwner(userId);
        // ì“°ê¸°: ì†Œìœ ìë§Œ ê°€ëŠ¥ (ê³µìœ ë°›ì€ êµì‚¬ëŠ” í•™ìƒ ì •ë³´ ìˆ˜ì • ë¶ˆê°€)
        allow write: if isOwner(userId);
      }

      // íŒ€ ë°ì´í„° (Phase 1: ê³µìœ  ê¶Œí•œ ì¶”ê°€)
      match /teams/{teamId} {
        // ì½ê¸°: ì†Œìœ ì + ê³µìœ ë°›ì€ êµì‚¬ (hasSharedAccessë¡œ í™•ì¸)
        allow read: if isOwner(userId) || hasSharedAccess(userId, request.auth.uid);

        // ì“°ê¸°: ì†Œìœ ìë§Œ ê°€ëŠ¥ (íŒ€ êµ¬ì„± ë³€ê²½ì€ ì†Œìœ ìë§Œ)
        allow write: if isOwner(userId);
      }

      // ê²½ê¸° ë°ì´í„° (Phase 1: ê³µìœ  ê¶Œí•œ ì¶”ê°€) ğŸ”¥ í•µì‹¬!
      match /games/{gameId} {
        // ì½ê¸°: collectionGroup ê·œì¹™(í•™ìƒìš©)ì— ì˜í•´ ëª¨ë“  ì‚¬ëŒ ì¡°íšŒ ê°€ëŠ¥

        // ìƒì„±: ì†Œìœ ì + ê³µìœ ë°›ì€ í¸ì§‘ì ì´ìƒ
        // í¸ì§‘ìê°€ ê²½ê¸°ë¥¼ ìƒì„±í•  ë•Œë„ ownerIdëŠ” ì› ì†Œìœ ìë¡œ ì„¤ì •ë˜ì–´ì•¼ í•¨
        allow create: if isOwner(userId) || hasSharedAccess(userId, request.auth.uid);

        // ìˆ˜ì •: ì†Œìœ ì + ê³µìœ ë°›ì€ í¸ì§‘ì ì´ìƒ (ê²½ê¸° ì§„í–‰)
        allow update: if isOwner(userId) || hasSharedAccess(userId, request.auth.uid);

        // ì‚­ì œ: ì†Œìœ ìë§Œ ê°€ëŠ¥
        allow delete: if isOwner(userId);
      }

      // ì¢…ë£Œëœ ê²½ê¸° (Phase 1: ê³µìœ  ê¶Œí•œ ì¶”ê°€)
      match /finishedGames/{gameId} {
        // ì½ê¸°: collectionGroup ê·œì¹™(í•™ìƒìš©)ì— ì˜í•´ ëª¨ë“  ì‚¬ëŒ ì¡°íšŒ ê°€ëŠ¥

        // ì“°ê¸°: ì†Œìœ ì + ê³µìœ ë°›ì€ í¸ì§‘ì ì´ìƒ (ê²½ê¸° ì¢…ë£Œ ì‹œ ê¸°ë¡)
        allow write: if isOwner(userId) || hasSharedAccess(userId, request.auth.uid);
      }

      // ì„ ìˆ˜ ë°°ì§€ (Phase 1: ê³µìœ  ê¶Œí•œ ì¶”ê°€)
      match /playerBadges/{playerId} {
        // ì½ê¸°: collectionGroup ê·œì¹™(í•™ìƒìš©)ì— ì˜í•´ ëª¨ë“  ì‚¬ëŒ ì¡°íšŒ ê°€ëŠ¥

        // ì“°ê¸°: ì†Œìœ ì + ê³µìœ ë°›ì€ í¸ì§‘ì ì´ìƒ (ê²½ê¸° ì¤‘ ë°°ì§€ ìˆ˜ì—¬)
        allow write: if isOwner(userId) || hasSharedAccess(userId, request.auth.uid);
      }

      // ì„ ìˆ˜ íˆìŠ¤í† ë¦¬ (Phase 1: ê³µìœ  ê¶Œí•œ ì¶”ê°€)
      match /playerHistory/{playerId} {
        // ì½ê¸°: collectionGroup ê·œì¹™(í•™ìƒìš©)ì— ì˜í•´ ëª¨ë“  ì‚¬ëŒ ì¡°íšŒ ê°€ëŠ¥

        // ì“°ê¸°: ì†Œìœ ì + ê³µìœ ë°›ì€ í¸ì§‘ì ì´ìƒ (ê²½ê¸° ê¸°ë¡ ì—…ë°ì´íŠ¸)
        allow write: if isOwner(userId) || hasSharedAccess(userId, request.auth.uid);
      }

      // ì„¤ì •
      match /settings/{document=**} {
        allow read, write: if isOwner(userId);
      }

      // ì»¤ìŠ¤í…€ ë°°ì§€ (Phase 1)
      match /customBadges/{badgeId} {
        allow read: if isSignedIn();  // ëª¨ë“  ë¡œê·¸ì¸ ìœ ì €ê°€ ë³¼ ìˆ˜ ìˆìŒ
        allow write: if isOwner(userId);  // ë³¸ì¸ë§Œ ìˆ˜ì •
      }
    }

    // ============================================
    // ê¶Œí•œ ìš”ì²­ ì‹œìŠ¤í…œ (permissions ì»¬ë ‰ì…˜)
    // ============================================

    match /permissions/{permissionId} {
      // ê¶Œí•œ ìš”ì²­ ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ëŒ ëˆ„êµ¬ë‚˜
      allow create: if isSignedIn();

      // ê¶Œí•œ ìš”ì²­ ì½ê¸°: ìš”ì²­ì ë˜ëŠ” ì†Œìœ ì
      allow read: if isSignedIn() &&
                     (resource.data.requesterId == request.auth.uid ||
                      resource.data.ownerId == request.auth.uid);

      // ê¶Œí•œ ìš”ì²­ ìŠ¹ì¸/ê±°ë¶€: ì†Œìœ ìë§Œ
      allow update: if isSignedIn() && resource.data.ownerId == request.auth.uid;

      // ê¶Œí•œ ìš”ì²­ ì‚­ì œ: ìš”ì²­ì ë˜ëŠ” ì†Œìœ ì
      allow delete: if isSignedIn() &&
                       (resource.data.requesterId == request.auth.uid ||
                        resource.data.ownerId == request.auth.uid);
    }

    // ============================================
    // ê°œì¸ì •ë³´ ì²˜ë¦¬ ë™ì˜ (privacy_consents ì»¬ë ‰ì…˜)
    // ============================================

    match /privacy_consents/{consentId} {
      // ì½ê¸°: ë³¸ì¸ì˜ ë™ì˜ ê¸°ë¡ë§Œ
      allow read: if isSignedIn() &&
                     resource.data.teacherId == request.auth.uid;

      // ì“°ê¸°: ë³¸ì¸ì˜ ë™ì˜ ê¸°ë¡ë§Œ ìƒì„±/ìˆ˜ì • ê°€ëŠ¥
      allow write: if isSignedIn() &&
                      request.resource.data.teacherId == request.auth.uid &&
                      request.resource.data.consentType == 'teacher';
    }

    // ============================================
    // ê³µìœ  ì‹œìŠ¤í…œ (shares ì»¬ë ‰ì…˜) - Phase 1
    // ============================================

    match /shares/{shareId} {
      // ìƒì„±: ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ë³¸ì¸ì„ ì†Œìœ ìë¡œ í•˜ëŠ” ê³µìœ  ìƒì„± ê°€ëŠ¥
      allow create: if isSignedIn() &&
                       request.resource.data.ownerId == request.auth.uid &&
                       request.auth.uid in request.resource.data.permissions.owners;

      // ì½ê¸°: ì†Œìœ ì ë˜ëŠ” ê³µìœ  ì°¸ì—¬ì(viewer, editor, owner)ë§Œ ê°€ëŠ¥
      allow read: if isSignedIn() && (
        resource.data.ownerId == request.auth.uid ||
        request.auth.uid in resource.data.permissions.viewers ||
        request.auth.uid in resource.data.permissions.editors ||
        request.auth.uid in resource.data.permissions.owners
      );

      // ìˆ˜ì •: ì†Œìœ ìë§Œ ê°€ëŠ¥ (ê¶Œí•œ ë³€ê²½, í•­ëª© ì¶”ê°€/ì œê±° ë“±)
      allow update: if isSignedIn() &&
                       resource.data.ownerId == request.auth.uid &&
                       request.resource.data.ownerId == request.auth.uid;

      // ì‚­ì œ: ì†Œìœ ìë§Œ ê°€ëŠ¥
      allow delete: if isSignedIn() &&
                       resource.data.ownerId == request.auth.uid;
    }

    // ê³µìœ ë°›ì€ í•­ëª© ëª©ë¡ (users/{userId}/sharedWithMe)
    match /users/{userId}/sharedWithMe/{shareId} {
      // ì½ê¸°: ë³¸ì¸ì˜ ê³µìœ  ëª©ë¡ë§Œ ì¡°íšŒ ê°€ëŠ¥
      allow read: if isSignedIn() && request.auth.uid == userId;

      // ìƒì„±: ì´ˆëŒ€ ìˆ˜ë½ ì‹œì—ë§Œ ê°€ëŠ¥
      // - ë³¸ì¸ì˜ sharedWithMeì—ë§Œ ì¶”ê°€ ê°€ëŠ¥
      // - ì°¸ì¡°í•˜ëŠ” shares ë¬¸ì„œê°€ ì‹¤ì œë¡œ ì¡´ì¬í•˜ê³ 
      // - ìì‹ ì´ í•´ë‹¹ ê³µìœ ì˜ ì°¸ì—¬ì ëª©ë¡ì— í¬í•¨ë˜ì–´ ìˆì–´ì•¼ í•¨
      allow create: if isSignedIn() &&
                       request.auth.uid == userId &&
                       exists(/databases/$(database)/documents/shares/$(request.resource.data.shareId));

      // ìˆ˜ì •: ë³¸ì¸ì˜ ê¸°ë¡ë§Œ ìˆ˜ì • ê°€ëŠ¥ (permission ë³€ê²½ ì‹œ)
      allow update: if isSignedIn() &&
                       request.auth.uid == userId &&
                       resource.data.shareId == request.resource.data.shareId;

      // ì‚­ì œ: ë³¸ì¸ì˜ ê¸°ë¡ë§Œ ì‚­ì œ ê°€ëŠ¥ (ê³µìœ  íƒˆí‡´)
      allow delete: if isSignedIn() && request.auth.uid == userId;
    }
  }
}